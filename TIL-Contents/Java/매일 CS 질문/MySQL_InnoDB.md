# MySQL InnoDB에서 갭락과 넥스트키 락이란 무엇이며, 어떻게 팬텀 리드를 방지하나요?

### 내답변
> 일단 InnoDB와 갭락,넥스트키 락, 팬텀리드에 대한 용어 처음들음

- MySql에서 해당 용어대해서 숙지가 미숙하여 답변 드리기 어렵습니다.

---

### GPT 답변 (모를때 가정)

“갭락/넥스트키 락은 오늘 처음 듣는 용어라서,<br> 
지금 상태로는 정확히 설명드리면 오히려 틀릴 가능성이 큽니다.<br>

대신 면접 후에 InnoDB 잠금과 팬텀 리드 관계를 기준으로 공식 문서/재현 쿼리로 확인해서 정리해보겠습니다.<br>
혹시 제가 아는 범위인 ‘팬텀 리드’ 개념부터 설명드려도 될까요?”

> ✅ 포인트: 모름 인정 + 틀리기 싫다 + 학습 계획 + 대화 이어가기

---
### 또는
실무에서 MySQL을 많이 쓰긴 했는데,<br> 
갭락/넥스트키 락은 애플리케이션에서 직접 다루는 기능이 아니라<br>
InnoDB 내부 잠금 전략이라서 문제 상황(데드락/락 대기/팬텀 이슈)을 깊게 파지 않으면 용어를 접할 일이 적습니다.<br> 
저는 주로 PK 기반 CRUD 위주라 체감이 덜했고, 운영에서 락 이슈를 분석할 때 주로 만나게 되는 개념으로 알고 있습니다.”

---

### GPT 정답 답변 

1) 팬텀 리드(Phantom Read)란?
- 한 트랜잭션이 같은 조건으로 두 번 조회했을 때, 
- 중간에 다른 트랜잭션이 그 조건 범위에 INSERT를 해버리면<br>
두 번째 조회에서 처음엔 없던 행이 새로 나타나는 현상입니다.

2) 갭락(Gap Lock)이란?
- InnoDB가 인덱스 레코드와 레코드 사이의 “빈 범위(gap)” 자체에 거는 락입니다.
- 대상: “행”이 아니라 인덱스의 범위(빈 구간)
- 효과: 그 범위 안에 다른 트랜잭션이 새 레코드를 INSERT하는 것을 막음
- 예) 인덱스에 10, 20이 있을 때
    - (10, 20) 구간에 갭락이 걸리면 누가 15를 INSERT 못 합니다.
3) 넥스트키 락(Next-Key Lock)이란?
- 레코드 락(존재하는 행 잠금) + 갭락(범위 잠금) 을 합친 락입니다.
- “특정 인덱스 레코드”와 “그 레코드 앞의 gap”을 함께 잠그는 방식
- 효과:
    - 이미 존재하는 행에 대한 변경/잠금(레코드 락)
    - 그 주변 범위에 새 행이 끼어드는 INSERT 방지(갭락)
    - 즉, 행도 막고 + 범위에 새로 생기는 행도 막는 형태입니다.
4) 어떻게 팬텀 리드를 방지하나요?
- 팬텀 리드의 핵심 원인이 **“조건 범위에 새로운 행이 INSERT되는 것”**이기 때문에,
    - InnoDB는 (주로) REPEATABLE READ 격리 수준에서
    - 범위 조건 조회 시 넥스트키 락/갭락으로 그 범위를 잠가
    - 다른 트랜잭션이 해당 범위에 INSERT 못 하게 만들어
    - 같은 조건으로 다시 조회해도 새 행(phantom)이 나타나지 않게 합니다.

 